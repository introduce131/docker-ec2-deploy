name: Deploy to EC2 (Build on EC2)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key

      - name: Upload source to EC2
        run: |
          ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "mkdir -p ~/app"
          scp -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no -r \
            app.js Dockerfile package.json \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/app/

      - name: Build & Run on EC2
        run: |
          ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            cd ~/app

            # docker 권한 문제 방지 (필요시)
            sudo systemctl start docker || true

            # 기존 컨테이너 교체
            sudo docker stop docker-web-app 2>/dev/null || true
            sudo docker rm docker-web-app 2>/dev/null || true

            # 로컬에서 이미지 빌드
            sudo docker build -t docker-web-app:latest .

            # 실행
            sudo docker run -d \
              --name docker-web-app \
              --restart unless-stopped \
              -p 3000:3000 \
              docker-web-app:latest

            sudo docker ps | grep docker-web-app || true
          EOF
